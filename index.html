<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSC IQTAB - Intelligent Quality Tabulated Preparation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d111c; /* Deep Dark Background */
            color: #e2e8f0; /* Light text for contrast */
            scroll-behavior: smooth;
        }
        /* Custom scrollbar for aesthetics */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-thumb {
            background-color: #6366f1; /* Indigo */
            border-radius: 4px;
        }
        .critique-card {
            min-height: 250px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'iqtab-primary': '#4f46e5', // Indigo 600
                        'iqtab-secondary': '#fbbf24', // Amber 400
                        'iqtab-dark': '#0d111c', // Deep Dark
                        'iqtab-card': '#1a202c', // Slightly lighter dark for cards
                    }
                }
            }
        };
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{ "projectId": "placeholder" }');        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;

        setLogLevel('Debug');

        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config not available. Running in local mode.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        console.log("User signed out or anonymous.");
                        userId = null;
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
            }
        };

        initializeFirebase();

        // --- Gemini API Logic ---

        // Helper function for exponential backoff
        const fetchWithRetry = async (url, options, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Throw error to trigger retry if status is 429 or 5xx
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        window.generateAnswerCritique = async () => {
            const answerInput = document.getElementById('mains-answer-input');
            const critiqueOutput = document.getElementById('critique-output');
            const loadingIndicator = document.getElementById('critique-loading');
            const critiqueButton = document.getElementById('critique-button');

            const userQuery = answerInput.value.trim();

            if (!userQuery) {
                critiqueOutput.innerHTML = `<p class="text-red-400">Please enter your practice answer first.</p>`;
                return;
            }

            loadingIndicator.classList.remove('hidden');
            critiqueButton.disabled = true;
            critiqueOutput.innerHTML = '';

            const systemPrompt = `Act as an experienced UPSC Mains examiner and tutor. Your task is to critique a student's answer to a General Studies question. Provide feedback in a clear, structured Markdown format using the following headings:
1. **Content Relevance & Depth** (Max 5 points)
2. **Structure & Presentation** (Max 5 points)
3. **Suggestion for Improvement**`; // <--- CORRECTLY CLOSED STRING

const apiKey = "AIzaSyCmMEvdMI00zfhLtXE6UQRvDs3yxbGh3nQ"; // <--- YOUR KEY INSERTED
// Using a model suitable for text generation and structured response
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
